################################################################################
##                  Input Boolean
###################################################
input_boolean:
  gestione_luci_generale_sincronizzazioni:
    name: 'Sincronizzazione'
    icon: mdi:sync

  gestione_luci_tutte:
    name: 'Tutte le luci'
    icon: mdi:lightbulb-group

  gestione_luci_lampadario_soggiorno:
    name: 'Lampadario soggiorno'
    icon: mdi:ceiling-light

  gestione_luci_lampada_soggiorno:
    name: 'Lampada soggiorno'
    icon: mdi:floor-lamp

  gestione_luci_cucina:
    name: 'Luce Cucina'
    icon: mdi:globe-light

  gestione_luci_abat_jour:
    name: 'abat_jour'
    icon: mdi:lamp

  gestione_luci_ingresso_1:
    name: 'Luce Ingresso 1'
    icon: mdi:dome-light

  gestione_luci_ingresso_2:
    name: 'Luce Ingresso 2'
    icon: mdi:dome-light

  gestione_luci_bagno:
    name: 'Luce Bagno'
    icon: mdi:lightbulb

  gestione_luci_studio:
    name: 'Luce Studio'
    icon: mdi:lightbulb

  gestione_luci_cameretta:
    name: 'Luce Cameretta'
    icon: mdi:lightbulb

  gestione_luci_camera_da_letto:
    name: 'Camera da letto'
    icon: mdi:globe-light

  gestione_luci_sync_manuale:
    name: 'Sync Manuale'

  lampada_go_spegnimento_automatico_notte:
    name: 'Spegnimento automatico notte Lampada Go'
    icon: mdi:lightbulb-off

  lampada_go_scena_automatica_notte:
    name: 'Scena automatica notte Lampada Go'
    icon: mdi:theme-light-dark

  gestione_luci_periodo_giorno:
    name: 'Giorno'
  gestione_luci_periodo_crepuscolo:
    name: 'Crepuscolo'
  gestione_luci_periodo_sera:
    name: 'Sera'
  gestione_luci_periodo_notte:
    name: 'Notte'

  spegni_luci_con_allarme:
    name: Spegni luci con allarme
    icon: mdi:lightbulb-multiple-off
################################################################################
##                  Input Select
###################################################
input_select:
  gestione_luci_base_sync:
    name: 'Base'
    icon: mdi:theme-light-dark
    options:
      - 'Ora'
      - 'Sole'

  gestione_luci_scena_corrente:
    name: 'Attuale'
    icon: mdi:progress-clock
    options:
      - 'Relax'
      - 'Lettura'
      - 'Energia'
      - 'Concentrazione'
      - 'Luce brillante'
      - 'Luce soffusa'
      - 'Luce notturna'
      - 'Chiaro di luna'

  gestione_luci_scena_diurna_sync:
    name: 'Mattino'
    icon: mdi:progress-clock
    options:
      - 'Relax'
      - 'Lettura'
      - 'Energia'
      - 'Concentrazione'
      - 'Luce brillante'
      - 'Luce soffusa'
      - 'Luce notturna'
      - 'Chiaro di luna'
  
  gestione_luci_scena_crepuscolare_sync:
    name: 'Crepuscolo'
    icon: mdi:progress-clock
    options:
      - 'Relax'
      - 'Lettura'
      - 'Energia'
      - 'Concentrazione'
      - 'Luce brillante'
      - 'Luce soffusa'
      - 'Luce notturna'
      - 'Chiaro di luna'
      
  gestione_luci_scena_serale_sync:
    name: 'Sera'
    icon: mdi:progress-clock
    options:
      - 'Relax'
      - 'Lettura'
      - 'Energia'
      - 'Concentrazione'
      - 'Luce brillante'
      - 'Luce soffusa'
      - 'Luce notturna'
      - 'Chiaro di luna'

  gestione_luci_scena_notturna_sync:
    name: 'Notte'
    icon: mdi:progress-clock
    options:
      - 'Relax'
      - 'Lettura'
      - 'Energia'
      - 'Concentrazione'
      - 'Luce brillante'
      - 'Luce soffusa'
      - 'Luce notturna'
      - 'Chiaro di luna'

################################################################################
##                  Input Datetime
###################################################
input_datetime:
  gestione_luci_giorno:
    name: 'Inizio Mattino'
    icon: mdi:weather-sunny
    has_time: true
  gestione_luci_crepuscolo:
    name: 'Inizio Crepuscolo'
    icon: mdi:weather-sunset
    has_time: true
  gestione_luci_sera:
    name: 'Inizio Sera'
    icon: mdi:weather-sunset
    has_time: true
  gestione_luci_notte:
    name: 'Inizio Notte'
    icon: mdi:weather-night
    has_time: true

  lampada_go_attivazione_scena_notte:
    name: 'Lampada Go modalità notte'
    icon: mdi:weather-night
    has_time: true

  lampada_go_spegnimento_automatico_notte:
    name: 'Lampada Go modalità notte'
    icon: mdi:weather-night
    has_time: true

################################################################################
##                  Sensor
###################################################
sensor:
  - platform: template
    sensors:
      gestione_luci_fascia_oraria_sync:
        friendly_name: 'Fascia Oraria'
        value_template: >-
          {% if is_state("input_select.gestione_luci_base_sync", "Ora") %}

            {% if is_state('input_boolean.gestione_luci_periodo_giorno', 'on') %}
              Giorno
            {% elif is_state('input_boolean.gestione_luci_periodo_crepuscolo', 'on') %}
              Crepuscolo
            {% elif is_state('input_boolean.gestione_luci_periodo_sera', 'on') %}
              Sera
            {% elif is_state('input_boolean.gestione_luci_periodo_notte', 'on') %}
              Notte
            {% else %}
              Errore
            {% endif %}

          {% elif is_state("input_select.gestione_luci_base_sync", "Sole") %}
            
            {% if (as_timestamp(states.sun.sun.attributes.next_dusk)) - (as_timestamp(states.sun.sun.attributes.next_setting)) < 0 %}
              Sera
            {% elif (as_timestamp(states.sun.sun.attributes.next_rising)) - (as_timestamp(states.sun.sun.attributes.next_dawn)) < 0 %}
              Notte
            {% elif (states.sun.sun.attributes.elevation) < -5 %}
              Notte
            {% else %}
              Giorno
            {% endif %}
          
          {% else %}
            Errore
          {% endif %}
        icon_template: mdi:calendar-clock

      gestione_luci_selettore_stanza:
        friendly_name: 'Selettore Stanza'
        value_template: >-
          {% set stanza = states.sensor.last_alexa.state %}
          {%- if stanza == "media_player.soggiorno" -%}
            Soggiorno
          {%- elif stanza == "media_player.echo_show_cucina" -%}
            Cucina
          {%- elif stanza == "media_player.studio" -%}
            Studio
          {%- elif stanza == "media_player.camera_da_letto" -%}
            Camera_da_letto
          {%- elif stanza == "media_player.bagno" -%}
            Bagno
          {% else %}
            Errore
          {% endif %}
        icon_template: mdi:floor-plan

      gestione_luci_scena_corrente:
        friendly_name: Scena Corrente
        value_template: >-
          {{ states.input_select.gestione_luci_scena_corrente.state }}

  - platform: template
    sensors:
      luci_accese:
        friendly_name: 'Luci Accese'
        icon_template: 'mdi:lightbulb-group-outline'
        value_template: "{{ expand('group.tutte_le_luci') | selectattr('state', 'eq', 'on') | list | count }}"


################################################################################
##                  Group
###################################################
group:
  tutte_le_luci:
    entities:
      - light.luce_ingresso
      - light.luce_cucina
      - light.led_1_cucina
      - light.led_2_cucina
      - light.soggiorno_luce_piccola
      - light.abat_jour
      - light.lampada_sale
      - light.luce_bagno
      - light.luce_studio
      - light.hue_go
      - light.luce_camera_da_letto

light:
  - platform: group
    name: Tutte le luci
    entities:
      - light.luce_ingresso
      - light.luce_cucina
      - light.led_1_cucina
      - light.led_2_cucina
      - light.soggiorno_luce_piccola
      - light.abat_jour
      - light.lampada_sale
      - light.luce_bagno
      - light.luce_studio
      - light.hue_go
      - light.luce_camera_da_letto
################################################################################
##                  Script
###################################################
script:

######################################### Script Luci Transazione Lunga
  gestione_luci_sync_tutte_transazione_lunga:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_tutte
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Tutte'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110

  gestione_luci_sync_lampadario_soggiorno_transazione_lunga:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_lampadario_soggiorno
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Lampadario Soggiorno'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110

  gestione_luci_sync_lampada_soggiorno_transazione_lunga:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_lampada_soggiorno
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'lampada_soggiorno'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110

  gestione_luci_sync_bagno_transazione_lunga:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_bagno
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Bagno'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110
  
  gestione_luci_sync_abat_jour_transazione_lunga:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_abat_jour
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Abat-jour'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110

  gestione_luci_ingresso_transazione_lunga:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_ingresso_1
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_ingresso_2
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Ingresso'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110

  gestione_luci_studio_transazione_lunga:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_studio
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'studio'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110

  gestione_luci_cameretta_transazione_lunga:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_cameretta
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Cameretta'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110

######################################### Script Luci Transazione Corta
  gestione_luci_sync_tutte:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_tutte
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Tutte'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 110

  gestione_luci_sync_lampadario_soggiorno:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_lampadario_soggiorno
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Lampadario Soggiorno'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 2

  gestione_luci_sync_lampada_soggiorno:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_lampada_soggiorno
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'lampada_soggiorno'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 2

  gestione_luci_sync_bagno:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_bagno
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Bagno'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 2
  
  gestione_luci_sync_abat_jour:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_abat_jour
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Abat-jour'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 2

  gestione_luci_ingresso:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_ingresso_1
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_ingresso_2
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Ingresso'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 2

  gestione_luci_studio:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_studio
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'studio'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 2

  gestione_luci_cameretta:
    alias: 'Sincronizzazione Modello Attuale'
    icon: mdi:palette
    sequence:
      - condition: state
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
        state: 'on'
      - condition: state
        entity_id: input_boolean.gestione_luci_cameretta
        state: 'on'
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Cameretta'
          scene_name: '{{ states("input_select.gestione_luci_scena_corrente") }}'
          transition: 2
######################################### FINE Script Luci Transazione Corta

  gestione_luci_riattiva_sync:
    alias: 'Riattiva Sincronizzazione automatica'
    icon: mdi:sync-circle
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_tutte
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni

  gestione_luci_stop_sync:
    alias: 'Ferma Sincronizzazione automatica'
    icon: mdi:sync-off
    sequence:
      - service: input_boolean.turn_off
        entity_id: input_boolean.gestione_luci_generale_sincronizzazioni

  gestione_luci_alza_luminosita:
    alias: 'Luci al massimo'
    icon: mdi:sync-alert
    sequence:
      - service: hue.hue_activate_scene
        data_template:
          group_name: '{{states.gestione_luci_selettore_stanza.state}}'
          scene_name: 'Lettura'
          transition: 30

  gestione_luci_spegni_luci_stanza:
    alias: 'Spegni luci selezione stanza automatica'
    icon: mdi:sync-alert
    sequence:
      - choose:
        - conditions:
            - condition: template
              value_template: "{{ states.sensor.gestione_luci_selettore_stanza.state == 'Soggiorno' }}"
          sequence:
            - delay: 5
            - service: light.turn_off
              data:
                entity_id: ight.soggiorno_luce_piccola,light.abat_jour,light.lampada_sale

        - conditions:
            - condition: template
              value_template: "{{ states.sensor.gestione_luci_selettore_stanza.state == 'Cucina' }}"
          sequence:
            - delay: 5
            - service: light.turn_off
              data:
                entity_id: light.luce_cucina,light.led_1_cucina,light.led_2_cucina

        - conditions:
            - condition: template
              value_template: "{{ states.sensor.gestione_luci_selettore_stanza.state == 'Camera_da_letto' }}"
          sequence:
            - service: light.turn_off
              data:
                entity_id: light.luce_camera_da_letto

        - conditions:
            - condition: template
              value_template: "{{ states.sensor.gestione_luci_selettore_stanza.state == 'Studio' }}"
          sequence:
            - service: light.turn_off
              data:
                entity_id: light.

        - conditions:
            - condition: template
              value_template: "{{ states.sensor.gestione_luci_selettore_stanza.state == 'Bagno' }}"
          sequence:
            - service: light.turn_off
              data:
                entity_id: light.luce_studio

  gestione_luci_accendi_luci_stanza:
    alias: 'Accendi luci selezione stanza automatica'
    icon: mdi:sync-alert
    sequence:
      - choose:
        - conditions:
            - condition: template
              value_template: "{{ states.sensor.gestione_luci_selettore_stanza.state == 'soggiorno' }}"
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.abat_jour,light.soggiorno_luce_piccola

        - conditions:
            - condition: template
              value_template: "{{ states.sensor.gestione_luci_selettore_stanza.state == 'cucina' }}"
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.luce_cucina,light.led_1_cucina,light.led_2_cucina

        - conditions:
            - condition: template
              value_template: "{{ states.sensor.gestione_luci_selettore_stanza.state == 'camera_da_letto' }}"
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.camera_da_letto

################################################### Abbassa Luci
  gestione_luci_abbassa_luci:
    alias: 'Abbassa luci'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: "{{states.sensor.gestione_luci_selettore_stanza.state}}"
          scene_name: 'Galassia'
          transition: 30

  gestione_luci_abbassa_luci_soggiorno:
    alias: 'Abbassa luci Soggiorno'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Soggiorno'
          scene_name: 'Galassia'
          transition: 30

  gestione_luci_abbassa_luci_cucina:
    alias: 'Abbassa luci Cucina'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Cucina'
          scene_name: 'Galassia'
          transition: 30

  gestione_luci_abbassa_luci_ingresso:
    alias: 'Abbassa luci Ingresso'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Ingresso'
          scene_name: 'Galassia'
          transition: 30

  gestione_luci_abbassa_luci_studio:
    alias: 'Abbassa luci Studio'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Studio'
          scene_name: 'Galassia'
          transition: 30

  gestione_luci_abbassa_luci_camera_da_letto:
    alias: 'Abbassa luci Camera da letto'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Camera da letto'
          scene_name: 'Galassia'
          transition: 30

  gestione_luci_abbassa_luci_cameretta:
    alias: 'Abbassa luci Cameretta'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Cameretta'
          scene_name: 'Galassia'
          transition: 30

################################################### Alza Luci
  gestione_luci_alza_luci:
    alias: 'Alza Luci'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: "{{states.sensor.gestione_luci_selettore_stanza.state}}"
          scene_name: 'Lettura'
          transition: 30

  gestione_luci_alza_luci_soggiorno:
    alias: 'Alza luci Soggiorno'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Soggiorno'
          scene_name: 'Lettura'
          transition: 30

  gestione_luci_alza_luci_cucina:
    alias: 'Alza luci Cucina'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Cucina'
          scene_name: 'Lettura'
          transition: 30

  gestione_luci_alza_luci_ingresso:
    alias: 'Alza luci Ingresso'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Ingresso'
          scene_name: 'Lettura'
          transition: 30

  gestione_luci_alza_luci_studio:
    alias: 'Alza luci Studio'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Studio'
          scene_name: 'Lettura'
          transition: 30

  gestione_luci_alza_luci_camera_da_letto:
    alias: 'Alza luci Camera da letto'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Camera da letto'
          scene_name: 'Lettura'
          transition: 30

  gestione_luci_alza_luci_cameretta:
    alias: 'Alza luci Cameretta'
    icon: mdi:palette
    sequence:
      - service: input_boolean.turn_on
        entity_id: input_boolean.gestione_luci_sync_manuale
      - service: hue.hue_activate_scene
        data_template:
          group_name: 'Cameretta'
          scene_name: 'Lettura'
          transition: 30


################################################################################
##                  Template
###################################################
template:
  - binary_sensor:
      - name: gestione luci gruppo sync
        state: >
          {{ is_state('input_boolean.gestione_luci_lampadario_soggiorno', 'on')
            and is_state('input_boolean.gestione_luci_lampada_soggiorno', 'on')
            and is_state('input_boolean.gestione_luci_cucina', 'on')
            and is_state('input_boolean.gestione_luci_abat_jour', 'on')
            and is_state('input_boolean.gestione_luci_ingresso_1', 'on')
            and is_state('input_boolean.gestione_luci_ingresso_2', 'on')
            and is_state('input_boolean.gestione_luci_studio', 'on')
            and is_state('input_boolean.gestione_luci_bagno', 'on')
            and is_state('input_boolean.gestione_luci_cameretta', 'on')
            and is_state('input_boolean.gestione_luci_camera_da_letto', 'on') }}

################################################################################
##                  Automation
###################################################
automation:

  - alias: 'gestione_luci_set_fascia_oraria'
    id: 01FH6198R9VKMN775EADTRAZXP
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time
        at: input_datetime.gestione_luci_giorno
      - platform: time
        at: input_datetime.gestione_luci_crepuscolo
      - platform: time
        at: input_datetime.gestione_luci_sera
      - platform: time
        at: input_datetime.gestione_luci_notte
    action:
      - choose:
          - alias: "se mattino"
            conditions:
              - condition: template
                value_template: "{{ states.sensor.time.state == states('input_datetime.gestione_luci_giorno') [0:5] }}"
            sequence:
              - service: input_boolean.turn_on
                entity_id: input_boolean.gestione_luci_periodo_giorno
              - service: input_boolean.turn_off
                entity_id: 
                  - input_boolean.gestione_luci_periodo_crepuscolo
                  - input_boolean.gestione_luci_periodo_sera
                  - input_boolean.gestione_luci_periodo_notte
          
          - alias: "se crepuscolo"
            conditions:
              - condition: template
                value_template: "{{ states.sensor.time.state == states('input_datetime.gestione_luci_crepuscolo') [0:5] }}"
            sequence:
              - service: input_boolean.turn_on
                entity_id: input_boolean.gestione_luci_periodo_crepuscolo
              - service: input_boolean.turn_off
                entity_id: 
                  - input_boolean.gestione_luci_periodo_giorno
                  - input_boolean.gestione_luci_periodo_sera
                  - input_boolean.gestione_luci_periodo_notte
          
          - alias: "se sera"
            conditions:
              - condition: template
                value_template: "{{ states.sensor.time.state == states('input_datetime.gestione_luci_sera') [0:5] }}"
            sequence:
              - service: input_boolean.turn_on
                entity_id: input_boolean.gestione_luci_periodo_sera
              - service: input_boolean.turn_off
                entity_id: 
                  - input_boolean.gestione_luci_periodo_giorno
                  - input_boolean.gestione_luci_periodo_crepuscolo
                  - input_boolean.gestione_luci_periodo_notte

          - alias: "se notte"
            conditions:
              - condition: template
                value_template: "{{ states.sensor.time.state == states('input_datetime.gestione_luci_notte') [0:5] }}"
            sequence:
              - service: input_boolean.turn_on
                entity_id: input_boolean.gestione_luci_periodo_notte
              - service: input_boolean.turn_off
                entity_id: 
                  - input_boolean.gestione_luci_periodo_giorno
                  - input_boolean.gestione_luci_periodo_crepuscolo
                  - input_boolean.gestione_luci_periodo_sera

################################################### SELETTORE GRUPPI
  - alias: 'Gestione_luci_selezione_gruppi_tutte'
    id: 77dc3309b4214f3a7c8c60cce45c1b1e
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
    - platform: state
      entity_id: input_boolean.gestione_luci_tutte
      to: 'on'
    action:
    - service: input_boolean.turn_on
      entity_id:
        - input_boolean.gestione_luci_lampadario_soggiorno
        - input_boolean.gestione_luci_lampada_soggiorno
        - input_boolean.gestione_luci_cucina
        - input_boolean.gestione_luci_bagno
        - input_boolean.gestione_luci_abat_jour
        - input_boolean.gestione_luci_ingresso_1
        - input_boolean.gestione_luci_ingresso_2
        - input_boolean.gestione_luci_studio
        - input_boolean.gestione_luci_cameretta
        - input_boolean.gestione_luci_camera_da_letto
        - input_boolean.lampada_go_spegnimento_automatico_notte
        - input_boolean.lampada_go_scena_automatica_notte

  - alias: 'Gestione_luci_selezione_gruppi_tutte_off'
    id: f0eac9f89913bff1162960e671d81f20
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
    - platform: state
      entity_id: binary_sensor.gestione_luci_gruppo_sync
      to: 'off'
    action:
    - service: input_boolean.turn_off
      entity_id:
        - input_boolean.gestione_luci_tutte

  - alias: 'Gestione_luci_selezione_gruppi_tutte_on'
    id: 3419f0195bc617c35580d481090fb4b0
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
    - platform: state
      entity_id: binary_sensor.gestione_luci_gruppo_sync
      to: 'on'
    action:
    - service: input_boolean.turn_on
      entity_id:
        - input_boolean.gestione_luci_tutte

################################################### FINE SELETTORE GRUPPI

  - alias: 'gestione_luci_sync_impostazioni'
    id: 01FGFMDMV59Q1AXQ5ETBFWP9HG
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id:
        - sensor.gestione_luci_fascia_oraria_sync
        - input_boolean.gestione_luci_generale_sincronizzazioni

        - input_datetime.gestione_luci_giorno
        - input_datetime.gestione_luci_crepuscolo
        - input_datetime.gestione_luci_sera
        - input_datetime.gestione_luci_notte

        - input_select.gestione_luci_base_sync
        - input_select.gestione_luci_scena_corrente
        - input_select.gestione_luci_scena_diurna_sync
        - input_select.gestione_luci_scena_crepuscolare_sync
        - input_select.gestione_luci_scena_serale_sync
        - input_select.gestione_luci_scena_notturna_sync
        - input_boolean.gestione_luci_generale_sincronizzazioni

        - input_boolean.gestione_luci_lampadario_soggiorno
        - input_boolean.gestione_luci_lampada_soggiorno
        - input_boolean.gestione_luci_cucina
        - input_boolean.gestione_luci_abat_jour
        - input_boolean.gestione_luci_ingresso_1
        - input_boolean.gestione_luci_ingresso_2
        - input_boolean.gestione_luci_bagno
        - input_boolean.gestione_luci_studio
        - input_boolean.gestione_luci_cameretta
        - input_boolean.gestione_luci_camera_da_letto
    condition:
    - condition: state
      entity_id: input_boolean.gestione_luci_generale_sincronizzazioni
      state: 'on'
    action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.gestione_luci_scena_corrente
        option: >-
          {% if is_state("sensor.gestione_luci_fascia_oraria_sync", "Giorno") %}
            {{ states("input_select.gestione_luci_scena_diurna_sync") }}

          {% elif is_state("sensor.gestione_luci_fascia_oraria_sync", "Crepuscolo") %}
            {{ states("input_select.gestione_luci_scena_crepuscolare_sync") }}

          {% elif is_state("sensor.gestione_luci_fascia_oraria_sync", "Sera") %}
            {{ states("input_select.gestione_luci_scena_serale_sync") }}
          
          {% elif is_state("sensor.gestione_luci_fascia_oraria_sync", "Notte") %}
            {{ states("input_select.gestione_luci_scena_notturna_sync") }}
          
          {% else %}
            {{ states("input_select.gestione_luci_scena_diurna_sync") }}
          {% endif %}

    - service: script.gestione_luci_sync_lampadario_soggiorno_transazione_lunga
    - service: script.gestione_luci_sync_lampada_soggiorno_transazione_lunga
    - service: script.gestione_luci_sync_bagno_transazione_lunga
    - service: script.gestione_luci_sync_abat_jour_transazione_lunga
    - service: script.gestione_luci_ingresso_transazione_lunga
    - service: script.gestione_luci_studio_transazione_lunga
    - service: script.gestione_luci_cameretta_transazione_lunga

  - alias: 'gestione_luci_sync_lampadario_soggiorno'
    id: 01FGA8G1K5T62HYW8DVND37RT3
    mode: single
    max_exceeded: silent
    trigger:
    - platform: state
      entity_id: light.soggiorno_luce_piccola
      to: 'on'
    - platform: state
      entity_id: light.abat_jour
      to: 'on'
    - platform: state
      entity_id: light.luce_bagno
      to: 'on'
    - platform: state
      entity_id: light.luce_ingresso
      to: 'on'
    action:
    - service_template: >
        {% if trigger.entity_id == 'light.soggiorno_luce_piccola' %} script.gestione_luci_sync_lampadario_soggiorno
        {% elif trigger.entity_id == 'light.abat_jour' %} script.gestione_luci_sync_abat_jour
        {% elif trigger.entity_id == 'light.luce_bagno' %} script.gestione_luci_sync_bagno
        {% elif trigger.entity_id == 'light.luce_ingresso' %} script.gestione_luci_ingresso
        {% endif %}
          

  - alias: 'gestione_luci_sreset sync'
    id: 793d8c553d316b6d854449c9f4caf01c
    initial_state: true
    trigger:
      platform: time
      at: '03:00:00'
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.automazioni_luci_tutte
      - service: input_boolean.turn_on
        entity_id: input_boolean.automazioni_luci_generale_sincronizzazioni
      - service: input_boolean.turn_off
        entity_id: input_boolean.gestione_luci_sync_manuale
########################################

  - alias: 'Lampada go scena notte'
    id: 4e7aa161f5bbe043f31cf88262330090
    initial_state: true
    trigger:
      - platform: template
        value_template: "{{ states('sensor.time') == (states.input_datetime.lampada_go_attivazione_scena_notte.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
    condition:
      - condition: state
        entity_id: input_boolean.lampada_go_scena_automatica_notte
        state: 'on'
    action:
      - service: scene.turn_on
        target:
          entity_id: scene.lampada_go_notte
        data:
          transition: 2.5

  - alias: 'Lampada go spegnimento automatico'
    id: 4a84e7c4c1f750bad3dd6923cdaf6009
    initial_state: true
    trigger:
      - platform: template
        value_template: "{{ states('sensor.time') == (states.input_datetime.lampada_go_spegnimento_automatico_notte.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
    condition:
      - condition: state
        entity_id: input_boolean.lampada_go_spegnimento_automatico_notte
        state: 'on'
    action:
      - service: light.turn_off
        target:
          entity_id: light.hue_go


#################################### ACCENDI LUCE RIENTRO SERALE E' NEL PACKAGES PORTA INGRESSO


